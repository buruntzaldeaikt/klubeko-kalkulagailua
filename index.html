<!DOCTYPE html>
<html lang="eu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Klubeko Kuoten Kalkulagailua</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Roboto', Arial, sans-serif;
  background: #ffffff;
  color: #111;
  padding: 20px;
}
.card {
  background: #ffffff;
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.08);
  width: 95%;
  max-width: 1000px;
  margin: 0 auto;
}
h1 {
  margin: 0 0 12px;
  color: #387b5b;
}
.row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 8px;
}
label {
  font-weight: 600;
  font-size: 0.95rem;
  margin-bottom: 4px;
  display: block;
}
select, .output {
  padding: 6px 8px;
  border-radius: 8px;
  border: 1px solid #d0d7e0;
  font-size: 0.95rem;
}
.member {
  border: 1px dashed #c0e3c3;
  padding: 8px;
  border-radius: 10px;
  margin-bottom: 6px;
  background: #e6f3ec;
  transition: background 0.3s;
}
.member h3 {
  margin: 0 0 6px;
  font-size: 1rem;
}
.member.free { background: #fff3e0; }
.results {
  margin-top: 10px;
  padding: 8px;
  border-radius: 8px;
  background: #e6f3ec;
  font-weight: 700;
  width: 100%;
  box-sizing: border-box;
}
.small {
  font-size: 0.9rem;
  color: #555;
}
.inline {
  display: flex;
  gap: 8px;
  align-items: center;
}
.total {
  margin-top: 10px;
  padding: 10px;
  border-radius: 8px;
  background: #e6f3ec;
  font-weight: 800;
  font-size: 1.05rem;
  width: 100%;
  box-sizing: border-box;
}
button {
  padding: 6px 12px;
  border-radius: 8px;
  border: 0;
  background: #387b5b;
  color: #fff;
  cursor: pointer;
}
button:disabled {
  background: #c0dfc8;
  cursor: not-allowed;
}
.member .altaCuota {
  margin-top: 4px;
  font-weight: 600;
  color: #387b5b;
  font-size: 0.85rem;
}
.member .plazosCuota {
  margin-top: 2px;
  color: #555;
  font-size: 0.85rem;
}
.total-claro {
  display: block;
  font-size: 0.9em;
  color: #333;
  background-color: #f0f7f0;
  border: 1px solid #c0e3c3;
  padding: 6px 10px;
  margin-top: 8px;
  border-radius: 6px;
  line-height: 1.4em;
  text-align: right;
  width: fit-content;
  margin-left: auto;
}
.total-claro span.small {
  font-size: 0.8em;
  color: #387b5b;
  text-decoration: underline;
  cursor: pointer;
}
.popupLink {
  color: #387b5b;
  text-decoration: underline;
  cursor: pointer;
}
.resumenLine {
  font-size: 0.85em;
  margin-bottom: 2px;
}
.popupOverlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.popupBox {
  background: #ffffff;
  border-radius: 12px;
  max-width: 420px;
  padding: 20px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  text-align: left;
  font-size: 0.95rem;
}
.popupBox h3 {
  margin-top: 0;
  font-size: 1.1rem;
  color: #387b5b;
}
.popupClose {
  float: right;
  font-weight: bold;
  cursor: pointer;
  color: #387b5b;
}
.popupClose:hover {
  color: #333;
}
#infoContext {
  margin-bottom: 16px;
  padding: 12px;
  background: #e6f3ec;
  border: 1px solid #c0e3c3;
  border-radius: 8px;
  font-size: 0.95rem;
  line-height: 1.4;
}
#infoContext p { margin: 4px 0; }
#infoContext p strong { color: #387b5b; }
</style>
</head>
<body>
<div class="card">
  <h1>Klubeko kuoten kalkulagailua</h1>
  <div id="infoContext">
    <p><strong>2025eko otsailaren 22ko Batzar Orokorrean onartutako urteroko kuota</strong></p>
    <p>â„¹ï¸ URTEROKO KUOTA 6 zatitan kobratzen da, ordainketa errazagoa egiteko.</p>
    <p><strong>âš ï¸ EZ DIRA HILABETE, EGUN edo ORDUEI DAGOZKIEN ORDAINKETAK; </strong> URTE OSOKO KLUBAREN SOSTENGURAKO EGINDAKO BAZKIDE EKARPENAK BAIZIK.</p>
    <p>âš ï¸ Entrenamendu epea eta iraupena desberdina da kategoria edo atal bakoitzaren arabera.</p>
    <p>â„¹ï¸ 2025eko urriaren 1etik aurrera (Master taldearentzat azaroaren 1etik aurrera), izena ematen dutenek 28â‚¬ko alta-kuota ordaindu beharko dute.</p>
    <p>â„¹ï¸ Kuotaren ordainketarekin batera, izena emandako pertsona edo bere legezko tutoreetako bat klubeko bazkide egiten da, Batzar Nagusian parte hartu eta bozkatzeko eskubidearekin. <a href="https://www.buruntzaldeaikt.eus/kluba/estatutuak" target="_blank">Ikusi Estatutuak</a></p>
  </div>

  <div class="row">
    <div style="width:250px">
      <label>
        <input type="checkbox" id="useRGI" name="rgiCheck" class="rgiCheck">
        DSBE / BGDS hobaria aplikatu 
        <span class="small" title="RGI / IMV laguntza, %75eko deskontua. Deskontu hau aukeratuz gero, hilean 25a baino lehen laguntza jasotzeko ziurtagiria aurkeztu beharko duzu.">(?)</span>
      </label>
    </div>
    <div style="width:200px">
      <label for="totalFam">Familiakide kopurua</label>
      <select id="totalFam">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4 edo gehiago</option>
      </select>
    </div>
    <div style="width:160px; align-self:flex-end">
      <button id="loadBtn">SAKATU datuak kargatzeko eta HASTEKO</button>
    </div>
  </div>

  <div id="membersContainer"></div>

  <div id="summaryArea" style="display:none; width: 100%;">
    <div class="results"><strong>Laburpena</strong><br></div>
    <div class="results" id="resultsBox"></div>
    <div class="total" id="totalBox">Guztira: â€”</div>
  </div>
</div>

<script>

// --------------------- CONFIGURACIÃ“N DE CSV ---------------------
const csvSheets = {
"2019 Egun 1 Lasarte-Oria":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=1104631462&single=true&output=csv",
"2019 2 Egun Lasarte-Oria":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=594372538&single=true&output=csv",
"2018-2014 Lasarte-Oria":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=854262720&single=true&output=csv",
"2013-2012 Lasarte-Oria":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=174360607&single=true&output=csv",
"2011--> 18+ Lasarte-Oria":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=786890196&single=true&output=csv",
"2017--> 18+ Andoain":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=641105268&single=true&output=csv",
"Parte-hartze Igeriketa Egun 1":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=541455715&single=true&output=csv",
"Parte-hartze Igeriketa 2 Egun":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=2101736621&single=true&output=csv",
"Master Taldea":"https://docs.google.com/spreadsheets/d/e/2PACX-1vRk3A_LNtXB7oYO6aB-uPr8546sqdrxIGEvNkDxL2azMjwgxPNovIBfwO9U87vVo7KAk6zF6tJGfWVa/pub?gid=2128438898&single=true&output=csv"
};

let sheets = {};
const loadBtn = document.getElementById('loadBtn');
const membersContainer = document.getElementById('membersContainer');
const totalFamSelect = document.getElementById('totalFam');
const summaryArea = document.getElementById('summaryArea');
const resultsBox = document.getElementById('resultsBox');
const totalBox = document.getElementById('totalBox');
const useRGIcheckbox = document.getElementById('useRGI');

// --------------------- CARGA DE CSV ---------------------
loadBtn.addEventListener('click', async()=>{
Â  loadBtn.disabled=true; loadBtn.textContent='Kargatzen...';
Â  membersContainer.innerHTML=''; summaryArea.style.display='none'; sheets={};
Â  try{
Â  Â  await Promise.all(Object.entries(csvSheets).map(async([name,url])=>{
Â  Â  Â  const r = await fetch(url); if(!r.ok) throw new Error('Error al cargar '+name);
Â  Â  Â  const text = await r.text();
Â  Â  Â  sheets[name] = csvToObjects(text);
Â  Â  }));
Â  Â  createMemberBlocks();
Â  Â  summaryArea.style.display='block';
Â  Â  recalcAll();
Â  }catch(e){ alert('Error cargando CSV: '+e.message);}
Â  finally{loadBtn.disabled=false; loadBtn.textContent='Datuak kargatuta';}
});

totalFamSelect.addEventListener('change',()=>{
Â  createMemberBlocks();
Â  recalcAll();
});
useRGIcheckbox.addEventListener('change', recalcAll);

// --------------------- CREACIÃ“N DE BLOQUES ---------------------
function createMemberBlocks(){
Â  membersContainer.innerHTML='';Â 
Â  const count=Number(totalFamSelect.value);
Â  for(let i=0;i<count;i++){
Â  Â  const div=document.createElement('div'); div.className='member';
Â  Â  div.innerHTML=`<h3>${i+1} Familiakidea</h3>
Â  Â  <div style="display: flex; gap: 10px; flex-wrap: wrap;">Â 
Â  Â  Â  <div style="flex: 1; min-width: 280px; align-self: flex-start;">Â 
Â  Â  Â  Â  <label>Hautatu multzoa</label>
Â  Â  Â  Â  <select class="sheetSelect"></select>
Â  Â  Â  </div>
Â  Â  Â  <div style="flex: 1; min-width: 200px; align-self: flex-start;">Â 
Â  Â  Â  Â  <label>Hasiera hilabetea</label>
Â  Â  Â  Â  <select class="monthSelect"><option>â€”</option></select>
Â  Â  Â  </div>
Â  Â  Â <div style="flex: 1; min-width: 250px; align-self: flex-start;">Â 
<label>Dagokion kuota</label>
Â  Â  Â  Â  <div style="display: flex; gap: 8px; align-items: center; justify-content: space-between; flex-wrap: wrap;">Â 
Â  Â  Â  Â  Â  <div class="output feeDisplay" style="flex: 1;">â€”</div>Â 
Â  Â  Â  Â  Â  <div class="altaCuota" style="white-space: nowrap;"></div>Â 
Â  Â  Â  Â  Â  <div class="plazosCuota small" style="white-space: nowrap;"></div>Â 
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="explicacionCuota"></div>
Â  </div>`;
Â  Â  membersContainer.appendChild(div);
Â  Â  const sheetSel = div.querySelector('.sheetSelect');
Â  Â  Object.keys(csvSheets).forEach(name=>{
Â  Â  Â  const opt=document.createElement('option'); opt.value=name; opt.textContent=name; sheetSel.appendChild(opt);
Â  Â  });
Â  Â  sheetSel.addEventListener('change', ()=>{
Â  Â  Â  populateMonthsForMember(div);
Â  Â  Â  recalcAll();
Â  Â  });
Â  Â  div.querySelector('.monthSelect').addEventListener('change', recalcAll);
Â  }
Â  document.querySelectorAll('.member').forEach(m=>{
Â  Â  const s=m.querySelector('.sheetSelect');
Â  Â  if(s.options.length)s.selectedIndex=0;
Â  Â  populateMonthsForMember(m);
Â  });
}

// --------------------- POBLAR MESES ---------------------
function populateMonthsForMember(memberDiv){
Â  const sheetSel = memberDiv.querySelector('.sheetSelect');
Â  const monthSel = memberDiv.querySelector('.monthSelect');
Â  monthSel.innerHTML = '';
Â  const sheet = sheets[sheetSel.value];
Â  if(!sheet){Â 
Â  Â  monthSel.innerHTML='<option>â€”</option>';Â 
Â  Â  return;
Â  }
Â  const months = sheet.map(r => r['Mes inicio']).filter(Boolean);
Â  const seen = new Set();
Â  const uniq = months.filter(m => (seen.has(m)?false:seen.add(m)));
Â  if(uniq.length === 0){
Â  Â  Â  monthSel.innerHTML='<option>â€”</option>';
Â  } else {
Â  Â  Â  uniq.forEach(m=>{
Â  Â  Â  Â  Â  const o = document.createElement('option');
Â  Â  Â  Â  Â  o.value = m;
Â  Â  Â  Â  Â  o.textContent = m;
Â  Â  Â  Â  Â  monthSel.appendChild(o);
Â  Â  Â  });
Â  Â  Â  monthSel.selectedIndex = 0;
Â  }
}

// --------------------- PARSE CSV ---------------------
function csvToObjects(csv){
Â  const rows=[]; const lines=csv.split(/\r\n|\n/);Â 
Â  if(lines.length<9) return rows;
Â  const headers=parseCsvLine(lines[7]);
Â  for(let i=8;i<lines.length;i++){
Â  Â  if(!lines[i].trim()) continue;
Â  Â  const vals=parseCsvLine(lines[i]);Â 
Â  Â  const obj={};
Â  Â  for(let j=0;j<headers.length;j++) obj[headers[j].trim()]=vals[j]?vals[j].trim():'';Â 
Â  Â  rows.push(obj);
Â  }Â 
Â  return rows;
}
function parseCsvLine(line){
Â  const result=[]; let inQuotes=false, val='';Â 
Â  for(let i=0;i<line.length;i++){
Â  Â  const ch=line[i];
Â  Â  if(ch==='\"') inQuotes=!inQuotes;
Â  Â  else if(ch===',' && !inQuotes){ result.push(val); val=''; }
Â  Â  else val+=ch;
Â  }
Â  result.push(val); return result;
}

// --------------------- CÃLCULO DE CUOTAS ---------------------
function recalcAll(){
Â  const members = document.querySelectorAll('.member');
Â  const countFam = Number(totalFamSelect.value);
Â  const useRGI = useRGIcheckbox.checked;
Â  const fees = [];

Â  members.forEach((m)=>{
Â  Â  const sheetName = m.querySelector('.sheetSelect').value;
Â  Â  const month = m.querySelector('.monthSelect').value;
Â  Â  const sheet = sheets[sheetName];
Â  Â  let fee = 0;
Â  Â  let row = null;
    const monthSel = m.querySelector('.monthSelect');
    const monthIndex = monthSel.selectedIndex;
    const isMaster = sheetName.includes('Master');

Â  Â  if(sheet && month && month !== 'â€”'){
Â  Â  Â  row = sheet.find(r => r['Mes inicio']?.trim() === month.trim());
Â  Â  Â if(row){
Â  Â  Â  Â  fee = parseFloat((row['1 familiar']||'0').replace(',','.').replace('â‚¬','')) || 0;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (useRGI && fee > 0) {
Â  Â  Â  Â  Â  fee = fee * 0.25;Â 
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }

Â  Â  fees.push({div:m, fee, row, sheetName, month, monthIndex, isMaster});
Â  Â  m.classList.remove('free');
Â  });

Â  // Ajuste por nÃºmero de familiares si NO RGI
Â  if(!useRGI){
Â  Â  if(countFam === 2){
Â  Â  Â  fees.forEach(f => {
Â  Â  Â  Â  if(f.row) f.fee = parseFloat((f.row['2 familiares']||f.fee).replace(',','.').replace('â‚¬','')) || f.fee;
Â  Â  Â  });
Â  Â  } else if(countFam === 3){
Â  Â  Â  const sorted = [...fees].sort((a,b)=>b.fee - a.fee);
Â  Â  Â  if(sorted[0] && sorted[0].row) sorted[0].fee = parseFloat((sorted[0].row['2 familiares']||sorted[0].fee).replace(',','.').replace('â‚¬','')) || sorted[0].fee;
Â  Â  Â  if(sorted[1] && sorted[1].row) sorted[1].fee = parseFloat((sorted[1].row['2 familiares']||sorted[1].fee).replace(',','.').replace('â‚¬','')) || sorted[1].fee;
Â  Â  Â  if(sorted[2] && sorted[2].row) sorted[2].fee = parseFloat((sorted[2].row['Tercer familiar']||sorted[2].fee).replace(',','.').replace('â‚¬','')) || sorted[2].fee;
Â  Â  } else if(countFam >= 4){
Â  Â  Â  const sorted = [...fees].sort((a,b)=>b.fee - a.fee);
Â  Â  Â  if(sorted[0] && sorted[0].row) sorted[0].fee = parseFloat((sorted[0].row['2 familiares']||sorted[0].fee).replace(',','.').replace('â‚¬','')) || sorted[0].fee;
Â  Â  Â  if(sorted[1] && sorted[1].row) sorted[1].fee = parseFloat((sorted[1].row['2 familiares']||sorted[1].fee).replace(',','.').replace('â‚¬','')) || sorted[1].fee;
Â  Â  Â  if(sorted[2] && sorted[2].row) sorted[2].fee = parseFloat((sorted[2].row['Tercer familiar']||sorted[2].fee).replace(',','.').replace('â‚¬','')) || sorted[2].fee;
Â  Â  Â  for(let i=3;i<sorted.length;i++) sorted[i].fee = 0;
Â  Â  }
Â  }

Â  // Cuota de alta y Plazos
Â  fees.forEach(f=>{
Â  Â  const altaDiv = f.div.querySelector('.altaCuota');
Â  Â  const monthIndex = f.monthIndex;
Â  Â  const isMaster = f.isMaster;

    // LÃ³gica de Alta: Index 0 (Octubre o Noviembre para Master) NO paga. Index 1 o mÃ¡s SÃ paga 28â‚¬.
Â  Â  let alta = 0;
Â  Â  if (isMaster) {
Â  Â  Â  Â  alta = (monthIndex >= 1) ? 28 : 0;
Â  Â  } else {
Â  Â  Â  Â  alta = (monthIndex >= 1) ? 28 : 0;
Â  Â  }
Â  Â  f.alta = alta;
Â  Â  altaDiv.innerHTML = alta ? `<span style="color:#a0522d;">Alta kuota: ${alta.toFixed(2)} â‚¬</span>` : '';

    // LÃ³gica de Plazos Restantes
    let plazos = 6 - monthIndex;
    if(plazos < 1) plazos = 1;

    f.plazosRestantes = plazos;
    f.plazosPosteriores = plazos > 1 ? plazos - 1 : 0;
Â  });

Â  // Mostrar cuota y Plazos en los bloques de familiar
Â  fees.forEach(f=>{
Â  Â  const display = f.div.querySelector('.feeDisplay');
Â  Â  display.textContent = f.fee > 0 ? f.fee.toFixed(2)+' â‚¬' : '0.00 â‚¬ (ez du ordaintzen)';

    // ExplicaciÃ³n de Cuota y Plazos
Â  Â  const explainerDiv = f.div.querySelector('.explicacionCuota');Â 
Â  Â  let explainerText = '';
    
Â  Â  if (f.monthIndex > 0) {
Â  Â  Â  explainerText = `
Â  Â  Â  Â  <p style="font-size: 0.85rem; color: #1e8449; margin-top: 5px; padding: 5px; border-left: 3px solid #1e8449; background-color: #f0fff0;">
Â  Â  Â  Â  Â  *Kuota eta epeen egokitzapena:* Bazkide egiteko momentua urriaren 1etik aurrera bada (azaroaren 1etik aurrera Master taldean), urteko kuota egokitu egiten da gainontzeko guztiekin batera martxoan amaitzeko (apirilean Master taldearen kasuan). Burutu ez diren hilabeteak kontutan hartzen dira.<br><br>**Alta-kuota:** Urriaren 1etik aurrera (azaroren 1etik aurrera Master taldean) hasten direnek 28 â‚¬-ko alta-kuota dute. Data hori baino lehen izena ematen dutenek EZ dute alta-kuotarik ordaintzen.
Â  Â  Â  Â  </p>
Â  Â  Â  `;
Â  Â  }
Â  Â  explainerDiv.innerHTML = explainerText;

    // Plazo y Info Popup
    let plazoText = '';
    let infoPopupText = ''; 
    
    if(f.plazosRestantes > 0) {
        if (f.plazosRestantes > 1) {
            plazoText = `${f.plazosRestantes} helbideratutako epe`;
            const mesesBase = ['Urria', 'Azaroa', 'Abendua', 'Urtarrila', 'Otsaila', 'Martxoa'];
            const mesesMaster = ['Azaroa', 'Abendua', 'Urtarrila', 'Otsaila', 'Martxoa', 'Apirila'];
            const meses = f.isMaster ? mesesMaster : mesesBase;
            const mesesCobro = meses.slice(f.monthIndex, f.monthIndex + f.plazosRestantes).join(', ');
            infoPopupText = `<b>{${mesesCobro}}</b> hilabeteen <b>1etik 5era bitartean</b>`;
        } else {
            plazoText = 'Transferentzia bidezko ordainketa 1';
            infoPopupText = 'Izen-ematea egiteko momentuan. <br>Klubak ABANCAn duen kontura transferentzia<br><b>ABANCA ES75 2080 3637 8130 4003 7051</b>';
        }
    } else {
        plazoText = 'â€”';
    }
    
    // **NOTA:** El problema estÃ¡ en cÃ³mo se inyecta el HTML que contiene `popupLink`.
    // La soluciÃ³n es tener un listener que detecte todos los clics en la clase.
    const infoLink = `<span class="popupLink" data-info="ğŸ“… <b>Ordainketa data:</b><br>${infoPopupText}"><small>[info]</small></span>`;
    f.div.querySelector('.plazosCuota').innerHTML = `${plazoText} ${infoLink}`;
Â  });

// Total Anual
Â  Â  const totalCuotasAnuales = fees.reduce((acc,f)=>acc + f.fee * f.plazosRestantes, 0);
Â  Â  const totalAltas = fees.reduce((acc,f)=>acc + f.alta, 0);
Â  Â  const totalAnual = totalCuotasAnuales + totalAltas;

Â  Â  // Primer pago: (1 cuota + alta)
Â  Â  const totalPrimerPago = fees.reduce((acc,f)=>acc + f.fee + f.alta, 0); 

Â  Â  // Calcular la suma total de dinero a pagar en los plazos posteriores (sin alta).
Â  Â  const montoTotalPagosPosteriores = fees.reduce((acc, f) => acc + f.fee * f.plazosPosteriores, 0); 
    
    // ----------------------------------------------------
    // INYECCIÃ“N DEL HTML EN totalBox
    // ----------------------------------------------------

    let primerPagoPorFamiliar = '';
    let pagosPosterioresPorFamiliar = '';
    
    fees.forEach((f, idx) => {
        const montoPrimerPago = f.fee + f.alta;
        const altaTexto = f.alta > 0 ? ` + ${f.alta.toFixed(2)} â‚¬ Alta` : '';
        const nombreGrupo = f.div.querySelector('.sheetSelect').value;
        
        // 1. DESGLOSE PRIMER PAGO (Cuota + Alta)
        primerPagoPorFamiliar += `
            <div class="small" style="margin-left:10px; font-weight: normal; margin-top: 2px;">
                ${idx + 1} Familikidea: <b>${montoPrimerPago.toFixed(2)} â‚¬</b> 
                (<span title="${nombreGrupo} | Mes de inicio: ${f.month}">${f.fee.toFixed(2)} â‚¬ Cuota</span>${altaTexto})
            </div>
        `;
        
        // 2. DESGLOSE PAGOS POSTERIORES
        if (f.plazosPosteriores > 0) {
            pagosPosterioresPorFamiliar += `
                <div class="small" style="margin-left:10px; font-weight: normal; margin-top: 2px;">
                    ${idx + 1} Familikidea: ${f.plazosPosteriores} x ${f.fee.toFixed(2)} â‚¬
                </div>`;
        } else {
            pagosPosterioresPorFamiliar += `
                <div class="small" style="margin-left:10px; font-weight: normal; margin-top: 2px; color: #888;">
                    ${idx + 1} Familikidea: Ordainketa gehigarririk ez.
                </div>`;
        }
    });

    totalBox.innerHTML = `
        <div style="background:#fff; border-radius:10px; padding:10px 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); font-weight:700; margin-bottom:8px; color: #387b5b;">
            URTEAN ORDAINDU BEHARREKO GUZTIZKOA: ${totalAnual.toFixed(2)} â‚¬ 
            <div class="small" style="font-weight: normal; margin-top: 4px;">(Alta-kuota eta epe guztiak barneratzen ditu)</div>
        </div>

        <div style="display: flex; gap: 20px; border-top: 1px solid #c0d0c0; padding-top: 10px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 250px;">
                <strong style="display:block; margin-bottom: 5px; color: #a0522d;">LEHEN ORDAINKETAREN ZENBATEKOA: ${totalPrimerPago.toFixed(2)} â‚¬</strong>
                ${primerPagoPorFamiliar}
            </div>
            <div style="flex: 1; min-width: 250px;">
                <strong style="display:block; margin-bottom: 5px; color: #2a5a40;">ONDORENGO ORDAINKETAK: ${montoTotalPagosPosteriores.toFixed(2)} â‚¬</strong>
                <div class="small" style="font-weight: normal; margin-bottom: 5px;">(Lehen ordainketa kenduta, falta diren epeen batura)</div>
                ${pagosPosterioresPorFamiliar}
            </div>
        </div>
    `;

Â // --------------------- RESUMEN (resultsBox) ---------------------
resultsBox.innerHTML = '';
fees.forEach((f, idx) => {
Â  const sheetName = f.div.querySelector('.sheetSelect').value;
Â  const month = f.div.querySelector('.monthSelect').value;

Â  let cuotaText = f.fee > 0 ? f.fee.toFixed(2)+' â‚¬' : '0.00 â‚¬';
Â  let altaText = f.alta ? ` + Alta-kuota: 28 â‚¬` : '';

Â  let plazosTotal = f.plazosRestantes;
Â  let formaPago = '';
Â  let monthIndex = f.div.querySelector('.monthSelect').selectedIndex;

Â  if (monthIndex >= 0 && monthIndex <= 5) {
Â  Â  formaPago = `<span class="popupLink" data-info='ğŸ¦â†ªï¸ <b>Helbideratutako ordainketa:</b><br>Hileroko banku helbideraketa bidez egiten da.<br>Azken epea <b>martxoaren 1etik 5era</b> bitartekoa da "Master" taldean izan ezik, non azken epea <b>apirilaren 1etik 5era</b> bitartean egiten den.'>Helbideratutako ordainketa</span>`;
Â  } else {
Â  Â  formaPago = `<span class="popupLink" data-info='ğŸ¦â¡ï¸ <b>Banku transferentzia:</b><br>Banku transferentzia bidez ordainketa bakarra egiten da zehaztutako kontura:<br><b>ABANCA ES75 2080 3637 8130 4003 7051</b>.'>Banku transferentzia</span>`;
Â  }
Â 
Â  let detallePagoPosterior = '';
Â  if (f.plazosPosteriores > 0 && f.fee > 0) {
Â  Â  detallePagoPosterior = `
Â  Â  Â  <span style="display:block; margin-top:2px; padding-left:10px; font-size:0.8em; color:#555;">
Â  Â  Â  Â  â¡ï¸ **Ondorengo ordainketak:** ${f.plazosPosteriores} x ${f.fee.toFixed(2)} â‚¬ (klubeko kuota bakarrik)
Â  Â  Â  </span>
Â  Â  `;
Â  } else if (f.plazosRestantes === 1 && f.fee > 0) {
Â  Â  detallePagoPosterior = `
Â  Â  Â  <span style="display:block; margin-top:2px; padding-left:10px; font-size:0.8em; color:#555;">
Â  Â  Â  Â  â¡ï¸ **Ordainketa bakarra** (Transferentzia): ${(f.fee + f.alta).toFixed(2)} â‚¬
Â  Â  Â  </span>
Â  Â  `;
Â  }

Â  const div = document.createElement('div');
Â  div.className = 'resumenLine';
Â  div.innerHTML = `
Â  Â  **${idx+1} Familiakidea:** ${sheetName} (${month})<br>
Â  Â  **Lehen ordainketa:** <b>${(f.fee + f.alta).toFixed(2)} â‚¬</b> (${cuotaText.replace(' â‚¬', '')} Kuota ${altaText}) | Epeak guztira: ${plazosTotal} (${formaPago})
Â  Â  ${detallePagoPosterior}
Â  `;
Â  resultsBox.appendChild(div);
});

// **Aseguramos que el listener se adjunte despuÃ©s de crear los elementos dinÃ¡micos**
attachPopupListeners();

} // Cierre correcto de recalcAll()

// --------------------- POPUPS MODERNOS (FunciÃ³n Centralizada) ---------------------

/**
 * FunciÃ³n genÃ©rica para mostrar el popup modal.
 * @param {string} title - TÃ­tulo del popup.
 * @param {string} content - Contenido HTML del popup.
 */
const showPopup = (title, content, buttonId = 'closePopup') => {
    // Crear overlay
    const overlay = document.createElement('div');
    overlay.className = 'popupOverlay';
    overlay.style.display = 'flex';
    
    // Crear ventana del popup
    const popup = document.createElement('div');
    // Estilos internos forzados para el popup
    popup.style.background = '#fff';
    popup.style.fontFamily = "'Roboto', Arial, sans-serif";
    popup.style.padding = '22px 26px';
    popup.style.borderRadius = '12px';
    popup.style.boxShadow = '0 6px 20px rgba(0,0,0,0.25)';
    popup.style.maxWidth = '420px';
    popup.style.textAlign = 'left';
    popup.style.fontSize = '0.95rem';
    popup.style.lineHeight = '1.5em';
    popup.style.color = '#333';
    popup.innerHTML = `
        <h3 style="margin-top:0; color:#387b5b; font-size:1.1rem;">${title}</h3>
        <p style="margin-bottom:0.8em;">${content}</p>
        <div style="text-align:right; margin-top:12px;">
            <button id="${buttonId}" style="padding:8px 15px; border:0; border-radius:8px; background:#387b5b; color:white; cursor:pointer; font-weight:600;">Itxi</button>
        </div>
    `;
    
    overlay.appendChild(popup);
    document.body.appendChild(overlay);

    // Cerrar al hacer clic en el botÃ³n
    document.getElementById(buttonId).addEventListener('click', () => {
        overlay.remove();
    });
    // Cerrar al hacer clic fuera del popup
    overlay.addEventListener('click', closeEvent => {
        if (closeEvent.target === overlay) overlay.remove();
    });
};

/**
 * Adjunta un listener de eventos a todo el documento para la clase .popupLink
 * (Necesario para elementos creados dinÃ¡micamente)
 */
function attachPopupListeners() {
    // Removemos el listener antiguo si existe para evitar duplicados
    document.removeEventListener('click', handlePopupClick);
    
    // Adjuntamos el nuevo listener
    document.addEventListener('click', handlePopupClick);
}

const handlePopupClick = e => {
    // Verificamos si el elemento clicado o su padre mÃ¡s cercano es un .popupLink
    const linkElement = e.target.closest('.popupLink');

    if (linkElement) {
        e.preventDefault();
        const infoText = linkElement.dataset.info;
        showPopup('Ordainketa Informazioa', infoText);
    }
};

// --------------------- POPUP RGI / IMV AL MARCAR CHECKBOX ---------------------
const rgiCheckbox = document.querySelector('#useRGI');
if (rgiCheckbox) {
Â  rgiCheckbox.addEventListener('change', () => {
    recalcAll();
Â  Â  if (rgiCheckbox.checked) {
Â  Â  Â  const infoText = `
Â  Â  Â  â„¹ï¸ <b>DSBE / BGDS laguntza</b><br><br>
Â  Â  Â  Kuotan <b>%75eko</b> hobaria.<br>
Â  Â  Â  Hobari hau hautatzen baduzu, aukeratzen baduzu, <b>hilero, 25a baino lehen</b> kobratu izanaren ziurtagiria aurkeztu beharko duzu.<br><br>Laguntza hau hautatzean familiakide kopuruen hobariak ez dira aplikatzen.
Â  Â  Â  `;

      showPopup('DSBE / BGDS hobariaren informazioa', infoText, 'closeRgiPopup');
    }
Â  });
}

// Inicializamos los listeners al cargar la pÃ¡gina por primera vez
attachPopupListeners();
</script>
</body>
</html>




















